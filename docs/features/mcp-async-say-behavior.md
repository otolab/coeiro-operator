# Queue統一実装による CLI vs MCP 実行モード

## 概要

COEIRO Operatorは、SpeechQueueを基盤とした統一実装により、CLIツールとMCPサーバーで最適化された動作を提供します。すべての音声処理（ウォームアップ、音声合成、完了待機）がqueue経由で実行されます。

## Queue統一実装の設計

### 共通基盤：SpeechQueue
- **タスクタイプ**: `speech`, `warmup`, `completion_wait`
- **処理方式**: 順次キュー処理で一貫性を保証
- **柔軟性**: 同期・非同期実行を両方サポート

### CLI実行モード（queue統一版）
- **目的**: ユーザーが音声の完了を確認できる同期的な動作
- **メソッド**: `synthesizeText()` 
- **動作フロー**: 
  1. `enqueueWarmupAndWait()` - ドライバーウォームアップ
  2. `enqueueAndWait()` - 音声合成実行
  3. `enqueueCompletionWaitAndWait()` - 再生完了待機
- **特徴**: 全てqueue経由、同期的に完了を待機

### MCP実行モード（queue統一版）
- **目的**: Claude Codeの応答性を重視した非同期動作
- **メソッド**: `synthesizeTextAsync()` → `enqueue()`
- **動作フロー**: SpeechQueueにタスク投稿のみ
- **特徴**: 即座にレスポンス、ウォームアップ・完了待機なし

## 動作の特徴

### レスポンス時間
- **CLI**: 音声合成完了まで待機（数秒）
- **MCP**: 即座にレスポンス（< 100ms）

### レスポンス内容
- **CLI**: 完了後に結果を表示
- **MCP**: タスク投稿の確認のみ

### ログ出力
- 音声合成の完了ログは非同期で出力されます
- エラーが発生した場合も非同期でログに記録されます

## 利点

1. **高速なレスポンス**: Claude Codeの応答性向上
2. **並行実行**: 複数の音声合成タスクの同時実行が可能
3. **ユーザビリティ**: 長い音声でもツールがブロックされない
4. **システム安定性**: 音声合成エラーがMCPサーバーをブロックしない

## 注意点

- 音声合成の完了確認は、ログまたは音声出力の開始で判断してください
- エラーが発生した場合、ツールのレスポンスではなくログに記録されます
- 音声合成の結果（成功/失敗）はツールのレスポンスには含まれません