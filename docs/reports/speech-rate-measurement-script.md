# 話速測定スクリプト実装レポート

## 実装日時
2025-01-21

## 概要
Speaker/スタイル毎の基準話速（モーラ/秒）を自動測定するスクリプトを実装しました。

## ファイル構成
- `packages/cli/scripts/measure-speech-rate.ts` - 測定スクリプト本体
- `packages/cli/scripts/README.md` - スクリプトの使用方法ドキュメント

## 技術的な設計

### モーラカウント
- 日本語の音韻単位「モーラ」を正確にカウント
- 拗音（きゃ、しゅ等）は1モーラ
- 長音（ー）、促音（っ）、撥音（ん）も各1モーラ
- テスト文章は事前にモーラ数を手動カウントして検証

### WAVファイル解析
- 標準的なWAVヘッダーから以下の情報を取得：
  - サンプリングレート
  - チャンネル数
  - ビット深度
  - データチャンクサイズ
- これらから正確な再生時間を計算

### 測定方法
1. 4つのテスト文章（19〜24モーラ）を用意
2. 各Speaker/スタイルでspeedScale=1.0で音声合成
3. 生成されたWAVファイルの再生時間を測定
4. モーラ数 ÷ 再生時間 = モーラ/秒
5. 複数文章の平均値を最終測定値とする

## 使用方法

```bash
# 測定実行（結果を標準出力）
npx tsx packages/cli/scripts/measure-speech-rate.ts

# 測定結果をファイルに保存
npx tsx packages/cli/scripts/measure-speech-rate.ts -o ./speech-rates.json
```

## 出力形式

### config.json用の設定
```json
{
  "characters": {
    "tsukuyomi": {
      "baseMorasPerSecond": 7.23,
      "styles": {
        "ノーマル": 7.23,
        "おしとやか": 6.89
      }
    }
  }
}
```

## 句読点ポーズ機能との連携

測定された`baseMorasPerSecond`値は、句読点ポーズ機能で以下のように使用されます：

1. 各キャラクターの基準話速として設定
2. speedScaleとの掛け算で実際の話速を計算
3. ポーズの長さ（モーラ数）を時間（ミリ秒）に変換

```typescript
// 例：speedScale=1.0、つくよみちゃん（7.23モーラ/秒）の場合
// 句点（2.0モーラ）のポーズ = 2.0 / 7.23 * 1000 = 約277ms
```

## 今後の改善案
- より多様なテスト文章での測定
- 感情表現による話速変化の測定
- 自動でconfig.jsonに反映する機能