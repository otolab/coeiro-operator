# 音声システム仕様

COEIRO Operatorの音声処理システムは、高品質なストリーミング音声合成・再生を実現するための包括的なソリューションです。

## アーキテクチャ概要

### ストリーミング処理パイプライン

```
COEIROINK API → WAV → PCM → リサンプリング → ローパスフィルター → ノイズリダクション → Speaker出力
    (24kHz)                    (24kHz → 48kHz)      (24kHz カットオフ)    (RNNoise AI)      (48kHz)
```

### コンポーネント構成

- **SpeechQueue**: 音声タスクの統一キュー管理（Queue統一実装の中核）
- **AudioSynthesizer**: COEIROINK API連携・音声生成
- **AudioPlayer**: ストリーミング処理・音声出力

### Queue統一実装アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│ 実行モード別エントリーポイント                                    │
├─────────────────────────────────────────────────────────────────┤
│ CLI: synthesizeText()     │ MCP: synthesizeTextAsync()          │
│ - ウォームアップタスク      │ - 音声タスクのみ                     │
│ - 音声タスク              │ - 即座にレスポンス                    │
│ - 完了待機タスク          │ - 背景で非同期実行                    │
│ - 同期完了確認            │                                     │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ SpeechQueue (統一タスク管理)                                      │
├─────────────────────────────────────────────────────────────────┤
│ タスクタイプ: speech | warmup | completion_wait                  │
│ - タスクID生成・キューイング                                      │
│ - 順次実行制御                                                   │
│ - CLI: 完了待機サポート                                          │
│ - MCP: 非同期実行サポート                                        │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
                        音声処理実行

## 音声処理技術

### 1. 高品質リサンプリング

**技術**: node-libsamplerate (libsamplerate)
- **アルゴリズム**: SRC_SINC_MEDIUM_QUALITY
- **変換**: 24000Hz → 48000Hz (2倍アップサンプリング)
- **特徴**: Transform streamベースのリアルタイム処理

```typescript
const resampleStream = new SampleRate({
  type: SampleRate.SRC_SINC_MEDIUM_QUALITY,
  channels: 1,
  fromRate: 24000,
  fromDepth: 16,
  toRate: 48000,
  toDepth: 16
});
```

### 2. ローパスフィルター

**技術**: dsp.js IIRFilter
- **カットオフ周波数**: 24000Hz
- **目的**: 高周波ノイズ・エイリアシング除去
- **タイプ**: デジタルIIRフィルター

### 3. AIノイズリダクション（オプション）

**技術**: Echogarden + RNNoise
- **エンジン**: AI学習ベースノイズ除去
- **処理**: リアルタイムスペクトラル処理
- **設定**: デフォルト無効（パフォーマンス重視）

## 設定システム

### サンプルレート分離

```json
{
  "synthesisRate": 24000,    // COEIROINK生成時
  "playbackRate": 48000,     // Speaker再生時
}
```

**利点**:
- 生成効率の最適化（24kHz）
- 再生品質の向上（48kHz）
- システムリソースのバランス

### フィルター設定

```json
{
  "lowpassFilter": true,
  "lowpassCutoff": 24000,
  "noiseReduction": false
}
```

## ストリーミング処理

### Transform Streamアーキテクチャ

各処理段階が独立したTransform streamとして実装：

```typescript
// パイプライン構築
resampleTransform
  .pipe(lowpassTransform)
  .pipe(noiseReductionTransform)
  .pipe(streamSpeaker);
```

### メモリ効率

- **チャンク処理**: 固定サイズバッファでの逐次処理
- **バックプレッシャー**: 自動的なフロー制御
- **エラーハンドリング**: 段階別エラー回復

## 音声出力

### Speakerライブラリ

**技術**: Native Node.js audio output
- **対応プラットフォーム**: Windows / macOS / Linux
- **特徴**: 低レイテンシ・高品質出力
- **フォーマット**: 16bit PCM, 48kHz, モノラル

### 旧システムからの改良

| 項目 | 旧システム | 新システム |
|------|------------|------------|
| 音声出力 | afplay/外部コマンド | speakerライブラリ（ネイティブ） |
| リサンプリング | 線形補間（自作） | libsamplerate（高品質） |
| フィルタリング | なし | dsp.js IIRフィルター |
| ノイズ除去 | なし | RNNoise AI（オプション） |
| 処理方式 | バッチ処理 | ストリーミング処理 |
| プラットフォーム | macOS限定 | クロスプラットフォーム |

## パフォーマンス

### 処理レイテンシ

- **音声生成**: ~100-200ms (COEIROINK依存)
- **リサンプリング**: ~1-5ms (チャンクサイズ依存)
- **フィルタリング**: ~0.1-1ms
- **総合レイテンシ**: ~150-250ms

### メモリ使用量

- **基本**: ~10-20MB
- **大容量音声**: ~50-100MB (一時的)
- **ストリーミング**: 一定メモリ使用量

## トラブルシューティング

### 一般的な問題

1. **音声が出力されない**
   - COEIROINKサーバー接続確認
   - Speaker権限確認
   - オーディオデバイス確認

2. **音質が悪い**
   - サンプルレート設定確認
   - フィルター設定調整
   - システムオーディオ設定確認

3. **レイテンシが高い**
   - チャンクサイズ調整
   - バッファサイズ最適化
   - ノイズリダクション無効化

### デバッグ

```bash
# 音声システムテスト
node say/cli.js "テスト音声"

# 詳細ログ有効化
DEBUG=audio* node say/cli.js "デバッグテスト"
```

## 今後の拡張

### 予定機能

- **リアルタイム音声変換**: 音高・テンポ調整
- **空間音響**: ステレオ・3D音響対応
- **音声効果**: リバーブ・エコー等
- **コーデック対応**: MP3・AAC出力
- **ハードウェア最適化**: GPU加速処理