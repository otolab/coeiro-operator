# オペレータアサイン状態管理仕様

## 概要

COEIRO Operatorにおけるオペレータアサイン状態の管理仕様。複数セッション間でのオペレータ重複防止と、時間切れによる自動解放機能を提供。

## 基本設計原則

### 1. 単一責任の原則
- 1つのオペレータは同時に1つのセッションのみが使用可能
- セッション間でのオペレータ重複は厳格に防止
- 時間切れオペレータは自動的に解放される（デフォルト4時間）

### 2. 一貫性の保証
- 全ての状態変更はファイルロック経由で実行
- 時間切れチェックは状態変更の前に必ず実行
- 複数の実行経路で一貫した状態管理を保証

### 3. 復旧性の確保
- プロセス異常終了時の自動回復
- 古い予約の自動クリーンアップ
- セッション識別による正確な状態管理

## データ構造

### アサイン状態ファイル
**ファイルパス**: `/tmp/coeiroink-operators-{hostname}.json`

```typescript
interface TimedStorage<T> {
  storage: Record<string, {  // sessionId -> timed data
    data: T;                 // オペレータの場合はoperatorId (string)
    updated_at: string;      // 最終更新時刻（ISO 8601形式）
  }>;
}
```

### セッション識別
優先順位に従って以下から選択：
1. `ITERM_SESSION_ID` (iTerm2環境)
2. `TERM_SESSION_ID` (ターミナル環境)
3. `process.ppid` (親プロセスID、フォールバック)

同一セッション内の全プロセスが同じオペレータを共有する。

## 状態遷移

```
[未使用] → [使用中] → [時間切れ] → [未使用]
```

### 状態の判定条件

- **使用中 (Busy)**: レコードに存在かつ有効期限内
- **利用可能 (Available)**: レコードに未存在または期限切れ
- **時間切れ**: 最終更新から4時間経過

## 主要処理フロー

### オペレータアサイン
1. セッションIDの取得
2. ファイルロック取得
3. 期限切れエントリのクリーンアップ
4. 重複チェック（他セッションで使用中でないか確認）
5. アサイン実行と記録
6. ファイル書き込み

### 自動解放メカニズム
- 各操作時に期限切れエントリを自動削除
- 明示的な解放コマンドも提供
- 異常終了時も4時間後に自動解放

## エラーハンドリング

### 主要エラーパターン
- **重複アサイン**: 他セッションで使用中
- **ファイルロック失敗**: リトライまたはエラー
- **データ破損**: 自動リカバリ（空状態から再開）

## 実装の参照先

- `/packages/core/src/operator/index.ts` - OperatorManager実装
- `/packages/core/src/operator/file-operation-manager.ts` - 汎用ファイル操作管理