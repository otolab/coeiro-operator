# テスト品質ガイドライン

## 📋 概要

このガイドは、COEIRO Operatorプロジェクトにおける効果的なテスト設計と品質保証のための指針を提供します。意味のあるテストを書き、十分なテストカバレッジを確保するための基本原則とチェックリストを示します。

## 🔗 関連ドキュメント

- [`docs/testing-guide.md`](./testing-guide.md) - テスト実行環境とmcp-debug統合
- [`docs/development-tips.md`](./development-tips.md) - 開発プロセス全般
- [`CLAUDE.md`](../../CLAUDE.md) - プロジェクト設定とコマンド実行環境

## 🎯 テスト品質の基本原則

### 1. 動作を検証する

**❌ 避けるべき**: 設定値やモック呼び出しの確認だけ
**✅ 目指すべき**: 実際の機能動作や期待される結果の検証

#### 基本的な考え方
- **「何が設定されているか」ではなく「何ができるか」をテスト**
- **実装の詳細ではなく、仕様・振る舞いをテスト**
- **モックの戻り値確認ではなく、その結果として起こる動作をテスト**

### 2. 失敗する可能性のあることをテストする

**❌ 避けるべき**: 常に成功するテスト、トートロジー的なテスト
**✅ 目指すべき**: エッジケース、エラー条件、パフォーマンス限界のテスト

#### 基本的な考え方
- **正常系だけでなく異常系もテスト**
- **境界値・エッジケースを重点的にテスト**
- **実際に失敗し得る条件でテスト**

### 3. テストの目的を明確にする

**❌ 避けるべき**: 何をテストしているか不明確
**✅ 目指すべき**: テスト名と内容で目的が明確

#### 基本的な考え方
- **テスト名で「何を」「どのような条件で」「どう検証するか」を表現**
- **1つのテストケースで1つの責務をテスト**
- **テストの意図をコメントで補足**

### 4. 現実的なテストデータを使用する

**❌ 避けるべき**: 非現実的な処理速度や規模の想定
**✅ 目指すべき**: 実際の使用パターンに基づくテストデータ

#### 基本的な考え方
- **実際のユーザー操作を模擬**
- **現実的なデータサイズと処理時間を想定**
- **本番環境に近い条件でテスト**

## ✅ テスト品質チェックリスト

### 新しいテストを作成する際

#### 🎯 目的の明確性
- [ ] テスト名で何をテストしているか明確になっている
- [ ] テストの意図がコード読者に伝わる
- [ ] 1つのテストで1つの責務のみをテストしている

#### 🔍 検証内容の妥当性
- [ ] 設定値確認ではなく、実際の動作を検証している
- [ ] モック呼び出し確認ではなく、その結果として起こる動作を検証している
- [ ] 実装の詳細ではなく、仕様・振る舞いを検証している

#### ⚠️ エラーハンドリング
- [ ] 正常系だけでなく異常系もテストしている
- [ ] エラー発生時のログ出力を検証している
- [ ] エラー後の復旧処理を検証している
- [ ] 境界値・エッジケースをテストしている

#### 📊 パフォーマンス・リソース
- [ ] 必要に応じてメモリ使用量を検証している
- [ ] 必要に応じて処理時間を検証している
- [ ] リソースリーク（メモリ、ファイルハンドルなど）を検証している

#### 📝 テストデータの現実性
- [ ] 実際の使用パターンに基づくテストデータを使用している
- [ ] 現実的なデータサイズを使用している
- [ ] 現実的な処理時間・パフォーマンス要件を設定している

### 既存のテストをレビューする際

#### 🚫 意味のないテストの特定
- [ ] 設定した値をそのまま確認しているだけのテストはないか
- [ ] モックの戻り値のみを確認しているテストはないか
- [ ] 常に成功するテストはないか
- [ ] トートロジー的なテストはないか

#### 📉 不十分なテストの特定
- [ ] エラーハンドリングが不十分ではないか
- [ ] エッジケースが考慮されていないか
- [ ] パフォーマンス要件が検証されていないか
- [ ] 統合テストが不足していないか

#### 🔧 テスト設計の問題
- [ ] 1つのテストが複数の責務をテストしていないか
- [ ] テストが複雑すぎないか
- [ ] テストデータが非現実的ではないか
- [ ] 重複するテストケースはないか

## 🏗️ テストの種類と設計指針

### 単体テスト（Unit Tests）
**目的**: 個別の関数・クラスの動作検証

#### 重点ポイント
- **純粋関数は入出力の検証に集中**
- **副作用のある処理は実際の副作用を検証**
- **依存関係はモック化し、テスト対象の責務のみを検証**

#### チェックポイント
- [ ] 関数の戻り値が期待通りか
- [ ] 副作用（ログ出力、ファイル操作など）が期待通りか
- [ ] エラー条件で適切な例外が発生するか

### 統合テスト（Integration Tests）
**目的**: コンポーネント間の連携動作検証

#### 重点ポイント
- **実際のデータフローを検証**
- **コンポーネント間のインターフェースを検証**
- **設定ファイルや環境変数の影響を検証**

#### チェックポイント
- [ ] コンポーネント間でデータが正しく渡されているか
- [ ] 設定変更が正しく反映されるか
- [ ] 実際のファイル・ネットワーク操作が成功するか

### E2Eテスト（End-to-End Tests）
**目的**: 実際のユーザーシナリオの検証

#### 重点ポイント
- **実際のサーバー・サービスとの通信を検証**
- **ユーザーの操作フローを模擬**
- **本番環境に近い条件でテスト**

#### チェックポイント
- [ ] 実際のCOEIROINKサーバーとの通信が成功するか
- [ ] 音声合成から再生までの完全なフローが動作するか
- [ ] 設定ファイルの変更が実際に反映されるか

## 🎯 プロジェクト固有の重要ポイント

### 音声合成システム特有のテスト
- **レイテンシ**: リアルタイム性の要件確認
- **音質**: 音声データの品質検証
- **メモリ効率**: 長時間動作でのメモリリーク検証
- **並行処理**: 並行チャンク生成の安全性検証

### MCPツール特有のテスト
- **プロトコル準拠**: JSON-RPC仕様への準拠確認
- **エラー応答**: 適切なエラーフォーマットの確認
- **引数バリデーション**: 必須パラメータチェック
- **レスポンス形式**: content配列構造の確認

### 設定管理特有のテスト
- **設定の階層化**: プリセット→個別設定→デフォルト値の優先順位
- **動的反映**: ランタイム設定変更の反映確認
- **検証**: 設定ファイル形式の妥当性確認

## 📚 学習リソース

### 推奨する学習順序
1. **テスト駆動開発の基本** - 「動作を検証する」の理解
2. **モックとスタブの使い分け** - 「何をモック化すべきか」の判断
3. **エラーハンドリングテスト** - 「失敗する可能性」の網羅
4. **パフォーマンステスト** - 「非機能要件」の検証方法

### 参考文献
- マーティン・ファウラー「リファクタリング」- テスト設計の原則
- ロバート・C・マーチン「クリーンコード」- テストコードの品質
- Gerard Meszaros「xUnit Test Patterns」- テストパターンの体系化

## 🚀 改善アクション

### 即座に実施すべき項目
1. **チェックリストの活用**: 新規テスト作成時に必ずチェック
2. **レビュー観点の統一**: コードレビューでテスト品質も確認
3. **意味のないテストの特定**: 既存テストの棚卸し

### 継続的改善項目
1. **テストメトリクスの収集**: カバレッジだけでなく品質指標も追跡
2. **テスト品質の定期レビュー**: 月次でテスト品質を振り返り
3. **チーム内知識共有**: 良いテスト例・悪いテスト例の共有

このガイドラインに従うことで、保守性が高く、実用的なテストスイートを構築し、COEIRO Operatorの品質を継続的に向上させることができます。