# ログレベルガイドライン

COEIRO Operatorプロジェクトでのログレベルの使い分けと運用方針について説明します。

## ログレベルの階層

詳細度が低い（重要）から高い（詳細）順に以下の階層があります：

```
logger.error  > logger.warn > logger.info > logger.log > logger.debug
    ↑                                                        ↑
   重要                                                    詳細
```

## 各ログレベルの用途

### `logger.error`
- **用途**: エラー情報とスタックトレース
- **対象**: システムの動作に影響する問題
- **例**: 
  - 音声プレーヤー初期化失敗
  - COEIROINKサーバー接続エラー
  - API呼び出し失敗

### `logger.warn`
- **用途**: 警告メッセージ
- **対象**: 動作は継続するが注意が必要な状況
- **例**:
  - スタイル設定のフォールバック実行
  - PCMデータが空
  - 非推奨機能の使用

### `logger.info`
- **用途**: 伝えたい重要な情報
- **対象**: ユーザーが知るべき状態や結果
- **例**:
  - 現在使用中のオペレータとスタイル
  - オーディオ出力設定（サンプルレート、バッファサイズ等）
  - 音声合成・再生の開始/完了通知
  - ファイル出力モード/ストリーミング再生モード

### `logger.log`
- **用途**: 今何をやっているかの簡潔な報告
- **対象**: 処理の進行状況やフロー把握
- **例**:
  - 音声合成の各チャンク処理
  - 音声再生の各段階
  - 高品質処理パイプライン開始
  - テキスト分割結果

### `logger.debug`
- **用途**: 開発・デバッグ用の詳細情報
- **対象**: 内部状態やパラメータの詳細
- **例**:
  - APIパラメータの詳細
  - 内部設定値
  - リサンプリング詳細

## 運用設定

### 一般的な使用時
- **ログレベル**: `info`
- **出力される内容**: `error`, `warn`, `info`
- **目的**: 重要な情報と警告のみ表示

### 静かな実行時
- **ログレベル**: `warn` 
- **出力される内容**: `error`, `warn`
- **目的**: 問題のある状況のみ表示

### デバッグ時
- **ログレベル**: `log` または `debug`
- **出力される内容**: 全レベル
- **目的**: 詳細な処理フロー確認

### MCPサーバーモード（通常）
- **ログレベル**: `error`（出力）/ `info`（蓄積）
- **出力される内容**: `error`のみ
- **蓄積される内容**: `error`, `warn`, `info`
- **目的**: stdout汚染防止とストレージ効率最適化

### MCPサーバーデバッグモード
- **ログレベル**: `debug`（出力）/ `debug`（蓄積）
- **出力される内容**: 全レベル
- **蓄積される内容**: 全レベル
- **目的**: 詳細なデバッグ情報の確認

## 実装のベストプラクティス

### 適切なログレベルの選択
```typescript
// ❌ 悪い例：重要な情報をlogに出力
logger.log('オペレータ音声を使用: つくよみちゃん');

// ✅ 良い例：重要な情報はinfoに出力  
logger.info('オペレータ音声を使用: つくよみちゃん (voice_id: xxx)');

// ❌ 悪い例：詳細すぎる情報をinfoに出力
logger.info('PCMデータサイズ: 75790bytes, channels: 1, bitDepth: 16');

// ✅ 良い例：詳細情報はlogに出力
logger.log('音声再生: チャンク0');
```

### ログメッセージの内容
- **簡潔で分かりやすく**: 必要な情報のみ含める
- **一貫性のある形式**: 同じタイプの処理は同じ形式で記録
- **エラー時は詳細を**: エラーレベルでは可能な限り詳細情報を含める

### パフォーマンス考慮
- 高頻度で呼ばれる処理では適切なレベルを選択
- デバッグ情報は必要な時のみ有効化されるよう設計

## 設定方法

### CLIでのログレベル設定
```typescript
// 通常使用
LoggerPresets.cli();      // info レベル

// デバッグ用  
LoggerPresets.debug();    // debug レベル

// 静かな実行
LoggerPresets.quiet();    // warn レベル
```

### MCPサーバーでのログレベル設定
```typescript
// MCPサーバーモード（通常運用）
LoggerPresets.mcpServerWithAccumulation(); // error出力/info蓄積

// MCPサーバーデバッグモード
LoggerPresets.mcpServerDebugWithAccumulation(); // debug出力/debug蓄積

// 蓄積なしのMCPサーバーモード  
LoggerPresets.mcpServer(); // error出力のみ
```

## ログ蓄積機能

### 蓄積レベルの独立制御
COEIRO Operatorでは、出力レベルと蓄積レベルを独立して制御できます：

- **出力レベル**: コンソールに表示されるログのレベル
- **蓄積レベル**: メモリ内に保存されるログのレベル

### MCPツールでのログ取得
蓄積されたログは`debug_logs`ツールで取得できます：

```typescript
// ログ統計の取得
debug_logs({ action: "stats" })

// 最新のログエントリ取得
debug_logs({ action: "get", limit: 50 })

// 特定レベルのログのみ取得
debug_logs({ action: "get", level: ["error", "warn"] })
```

### ストレージ効率の最適化
通常運用時はinfo以上のみを蓄積することで：
- メモリ使用量を削減
- 重要な情報は確実に保持
- デバッグ時には全情報を利用可能

このガイドラインに従うことで、適切なログ出力を実現し、デバッグ効率と運用品質を向上させることができます。